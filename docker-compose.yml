version: '3.6'

services:
  keycloak-db:
    image: postgres:16
    ports:
      - "5432"
    volumes:
      - ./keycloak/create-keycloak-db.sql:/docker-entrypoint-initdb.d/create-keycloak-db.sql
    networks:
      - ol-network
  keycloak:
      build:
        context: .
        dockerfile: ./keycloak/Dockerfile
        args:
          KEYCLOAK_THEME_GIT_REF: ${KEYCLOAK_THEME_GIT_REF:-main}
      command:
        - start-dev
        - --features=preview
        - --spi-theme-static-max-age=-1
        - --spi-theme-cache-themes=false
        - --spi-theme-cache-templates=false
        - --spi-login-provider=ol-freemarker
      environment:
        KC_DB: postgres
        KC_DB_URL_HOST: keycloak-db
        KC_DB_URL_PORT: 5432
        KC_DB_URL_DATABASE: keycloak
        KC_DB_USERNAME: keycloak
        KC_DB_PASSWORD: keycloak
        KC_DB_SCHEMA: public
        KEYCLOAK_ADMIN: admin
        KEYCLOAK_ADMIN_PASSWORD: password
      volumes:
        - ./repos/ol-keycloak/ol-keycloak/oltheme/target/keycloak-theme-ol-1.0-SNAPSHOT.jar:/opt/keycloak/providers/keycloak-theme-ol-1.0-SNAPSHOT.jar
      ports:
        - 8080:8080
      depends_on:
        - keycloak-db
      networks:
        - ol-network
      hostname: keycloak.odl.local

networks:
  ol-network:
    name: ol-network
