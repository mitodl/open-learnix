ssls:
  - cert: ${{OL_SSL_CERT}}
    key: ${{OL_SSL_KEY}}
    snis: 
      - "api.learn.odl.local"

upstreams:
  - id: mit-learn-nginx
    nodes:
      "mit-learn-nginx.internal.odl.local:8063": 1
    type: roundrobin

routes:
  - id: 1
    name: "passauth"
    desc: "Wildcard route that can use auth but doesn't require it."
    priority: 0
    upstream_id: mit-learn-nginx
    plugins:
      openid-connect:
        client_id: ${{KEYCLOAK_CLIENT_ID}}
        client_secret: ${{KEYCLOAK_CLIENT_SECRET}}
        discovery: ${{KEYCLOAK_DISCOVERY_URL}}
        realm: ${{KEYCLOAK_REALM_NAME}}
        scope: ${{KEYCLOAK_SCOPES}}
        bearer_only: false
        introspection_endpoint_auth_method: "client_secret_post"
        ssl_verify: false
        session:
          secret: ${{APISIX_SESSION_SECRET_KEY}}
        logout_path: "/logout/oidc"
        post_logout_redirect_uri: ${{APISIX_LOGOUT_URL}}
        unauth_action: "pass"
      cors:
        allow_origins: "**"
        allow_methods: "**"
        allow_headers: "**"
        allow_credential: true
      response-rewrite:
        headers:
          set:
            Referrer-Policy: "origin"
    uri: "*"
  - id: 2
    name: "logout-redirect"
    desc: "Strip trailing slash from logout redirect."
    priority: 10
    upstream_id: mit-learn-nginx
    uri: "/logout/oidc/*"
    plugins:
      redirect:
        uri: "/logout/oidc"
  - id: 3
    name: "reqauth"
    desc: "Routes that require authentication."
    priority: 10
    upstream_id: mit-learn-nginx
    plugins:
      openid-connect:
        client_id: ${{KEYCLOAK_CLIENT_ID}}
        client_secret: ${{KEYCLOAK_CLIENT_SECRET}}
        discovery: ${{KEYCLOAK_DISCOVERY_URL}}
        realm: ${{KEYCLOAK_REALM_NAME}}
        scope: ${{KEYCLOAK_SCOPES}}
        bearer_only: false
        introspection_endpoint_auth_method: "client_secret_post"
        ssl_verify: false
        session:
          secret: ${{APISIX_SESSION_SECRET_KEY}}
        logout_path: "/logout/oidc"
        post_logout_redirect_uri: ${{APISIX_LOGOUT_URL}}
        unauth_action: "auth"
      cors:
        allow_origins: "**"
        allow_methods: "**"
        allow_headers: "**"
        allow_credential: true
      response-rewrite:
        headers:
          set:
            Referrer-Policy: "origin"
    uris:
      - "/admin/login/*"
      - "/login/*"
#END
